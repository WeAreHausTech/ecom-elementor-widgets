name: Create Release

on:
  push:
    # Sequence of patterns matched against refs/tags
    tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10
  workflow_dispatch:

jobs:
  build:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          registry-url: https://registry.npmjs.org/
      - name: Install Dependencies
        run: npm install
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}

      - name: Build Widgets
        run: npm run build-widgets

      - name: Copy files to tmp folder
        run: mkdir -p ./tmp && cp -r ./dist ./src ./package.json ./yarn.lock ./README.md ./composer.json ./composer.lock ./livv-ecom-addon.php ./tmp

      - name: Set version in addon.php if github.ref is a tag else set it to dev
        # if: startsWith(github.ref, 'refs/tags/v')

        # Replace VERSION with the tag name in addon.php
        run: sed -i "s/VERSION/${{ github.ref }}/g" ./tmp/livv-ecom-addon.php
        
      # - name: Create ZIP file
      #   run: zip -r ./tmp/release.zip dist src package.json yarn.lock README.md composer.json composer.lock livv-ecom-addon.php

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          name: id_rsa
          known_hosts: ${{ secrets.SERVER_SSH_HOST }}

      - name: Upload files to server
        uses: appleboy/scp-action@master
        with:
          host: hemglass.se.staging.haus.se
          username: 'deploy'
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          source: ./tmp
          target: /mnt/persist/www/hemglass.se.staging.haus.se/shared/web/app/plugins/ecom-elementor-widgets.tmp

      - name: multiple command
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: hemglass.se.staging.haus.se
          username: deploy
          key: ${{ secrets.SERVER_PRIVATE_KEY }}
          port: 22
          script: |
            mv /mnt/persist/www/hemglass.se.staging.haus.se/shared/web/app/plugins/ecom-elementor-widgets /mnt/persist/www/hemglass.se.staging.haus.se/shared/web/app/plugins/ecom-elementor-widgets.old
            mv /mnt/persist/www/hemglass.se.staging.haus.se/shared/web/app/plugins/ecom-elementor-widgets.tmp/tmp /mnt/persist/www/hemglass.se.staging.haus.se/shared/web/app/plugins/ecom-elementor-widgets
            rm -rf /mnt/persist/www/hemglass.se.staging.haus.se/shared/web/app/plugins/ecom-elementor-widgets.tmp

      # - name: Create Release
      #   id: create_release
      #   uses: actions/create-release@v1
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # This token is provided by Actions, you do not need to create your own token
      #   with:
      #     tag_name: ${{ github.ref }}
      #     release_name: ${{ github.ref }}
      #     body: |
      #     draft: false
      #     prerelease: false

      # - name: Upload dist.zip to Release
      #   uses: actions/upload-release-asset@v1
      #   with:
      #     upload_url: ${{ steps.create_release.outputs.upload_url }}
      #     asset_path: ./release.zip
      #     asset_name: release.zip
      #     asset_content_type: application/zip
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
